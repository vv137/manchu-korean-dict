<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§Œì£¼ì–´ ì‚¬ì „</title>
    <link rel="stylesheet" href="styles.css">
    <script src="manchu-converter.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“– ë§Œì£¼ì–´ ì‚¬ì „</h1>
            <p>Manchu Dictionary</p>
        </header>

        <div class="stats" id="stats"></div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="" autocomplete="off" oninput="updateSearchPreview()">
                <button onclick="search()">ê²€ìƒ‰</button>
            </div>

            <div class="filters">
                <span class="filter-label">í•„í„°:</span>
                <select id="langFilter" onchange="search()">
                    <option value="">ëª¨ë“  ì–¸ì–´</option>
                    <option value="ko" selected>í•œêµ­ì–´ë§Œ</option>
                    <option value="en">ì˜ì–´ë§Œ</option>
                </select>
                <label class="checkbox-label">
                    <input type="checkbox" id="exampleSearch" onchange="search()">
                    <span>ì˜ˆë¬¸ì—ì„œë„ ê²€ìƒ‰</span>
                </label>
                <div class="filters-right">
                    <label class="checkbox-label">
                        <input type="checkbox" id="manchuInput" onchange="toggleManchuInput()">
                        <span>ë§Œì£¼ì–´ë¡œ ì…ë ¥</span>
                    </label>
                </div>
            </div>

            <div class="tag-filters" id="tagFilters"></div>

            <div class="results-info" id="resultsInfo"></div>
        </div>

        <div class="preview-card" id="previewCard">
            <div class="preview-manchu" id="previewManchu"></div>
        </div>

        <div class="results-section" id="results"></div>
    </div>

    <script>
        let dictionaryData = [];
        let allTags = new Set();
        let selectedTags = new Set();
        let manchuInputMode = false;

        function toggleManchuInput() {
            manchuInputMode = document.getElementById('manchuInput').checked;
            const searchInput = document.getElementById('searchInput');
            const previewCard = document.getElementById('previewCard');

            if (manchuInputMode) {
                searchInput.placeholder = "";
                // Input value preserved
            } else {
                searchInput.placeholder = "";
                // Input value preserved
                previewCard.classList.remove('active');
            }
            updateSearchPreview();
        }

        function updateSearchPreview() {
            const searchInput = document.getElementById('searchInput');
            const previewManchu = document.getElementById('previewManchu');
            const previewCard = document.getElementById('previewCard');

            if (!manchuInputMode || searchInput.value === '') {
                previewManchu.textContent = '';
                previewCard.classList.remove('active');
                return;
            }

            const latinText = searchInput.value;
            const manchuText = convertLatinToManchu(latinText);
            previewManchu.textContent = manchuText;
            previewCard.classList.add('active');
        }

        async function loadDictionary() {
            try {
                // ì‚¬ì „ ëª©ë¡ ë¡œë“œ
                const listResponse = await fetch('dictionaries/dictionaries.json');
                const list = await listResponse.json();

                // ê° ì‚¬ì „ ë¡œë“œ ë° ë³‘í•©
                const loadPromises = list.dictionaries.map(async (dictInfo) => {
                    const response = await fetch(`dictionaries/${dictInfo.file}`);
                    const data = await response.json();
                    console.log(`Loaded dictionary: ${data.meta?.name || dictInfo.id} (${data.entries.length} entries)`);
                    return data.entries;
                });

                const allEntries = await Promise.all(loadPromises);
                dictionaryData = allEntries.flat();

                dictionaryData.forEach(entry => {
                    if (entry.tags) {
                        entry.tags.forEach(tag => allTags.add(tag));
                    }
                });

                renderTagFilters();
                updateStats();
                search(); // 'í•œêµ­ì–´ë§Œ' ê¸°ë³¸ í•„í„° ì ìš©í•˜ì—¬ ê²€ìƒ‰
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('results').innerHTML =
                    '<div class="no-results"><div class="no-results-icon">âŒ</div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        function renderTagFilters() {
            const container = document.getElementById('tagFilters');
            allTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'tag-btn';
                btn.textContent = tag;
                btn.onclick = () => toggleTag(tag, btn);
                container.appendChild(btn);
            });
        }

        function toggleTag(tag, element) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
                element.classList.remove('active');
            } else {
                selectedTags.add(tag);
                element.classList.add('active');
            }
            search();
        }

        function normalizeSearchTerm(term) {
            if (term === 'i') {
                return ['i', '-i'];
            }
            return [term];
        }

        function matchesSearchTerm(text, searchTerms) {
            if (!text) return false;
            const lowerText = text.toLowerCase();
            return searchTerms.some(term => lowerText.includes(term));
        }

        function search() {
            let searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (manchuInputMode && searchTerm) {
                searchTerm = convertManchuToLatin(searchTerm).toLowerCase();
            }

            const langFilter = document.getElementById('langFilter').value;
            const exampleSearch = document.getElementById('exampleSearch').checked;

            let results = dictionaryData.filter(entry => entry && entry.headword);

            if (searchTerm) {
                const searchTerms = normalizeSearchTerm(searchTerm);

                results = results.filter(entry => {
                    const headwordMatch = matchesSearchTerm(entry.headword, searchTerms);
                    const romanMatch = matchesSearchTerm(entry.romanization, searchTerms);

                    const meaningMatch = entry.meanings && entry.meanings.some(m =>
                        matchesSearchTerm(m.text, searchTerms)
                    );

                    let exampleMatch = false;
                    if (exampleSearch && entry.examples) {
                        exampleMatch = entry.examples.some(ex =>
                            matchesSearchTerm(ex.manchu, searchTerms) ||
                            matchesSearchTerm(ex.translation_ko, searchTerms)
                        );
                    }

                    return headwordMatch || romanMatch || meaningMatch || exampleMatch;
                });

                results.sort((a, b) => {
                    const searchTerms = normalizeSearchTerm(searchTerm);
                    const aHeadword = matchesSearchTerm(a.headword, searchTerms) ? 0 :
                        matchesSearchTerm(a.romanization, searchTerms) ? 1 : 2;
                    const bHeadword = matchesSearchTerm(b.headword, searchTerms) ? 0 :
                        matchesSearchTerm(b.romanization, searchTerms) ? 1 : 2;

                    return aHeadword - bHeadword;
                });
            }

            if (langFilter) {
                results = results.filter(entry =>
                    entry.meanings && entry.meanings.some(m => m.lang === langFilter)
                );
            }

            if (selectedTags.size > 0) {
                results = results.filter(entry => {
                    if (!entry.tags) return false;
                    return Array.from(selectedTags).every(tag =>
                        entry.tags.includes(tag)
                    );
                });
            }

            displayResults(results, searchTerm);
        }

        function displayResults(results, searchTerm) {
            const resultsContainer = document.getElementById('results');
            const resultsInfo = document.getElementById('resultsInfo');

            resultsInfo.textContent = `${results.length}ê°œì˜ ê²°ê³¼`;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”</div>
                        <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = results.map(entry =>
                createEntryCard(entry, searchTerm)
            ).join('');
        }

        function createEntryCard(entry, searchTerm = '') {
            if (!entry || !entry.headword) {
                return '';
            }

            const langFilter = document.getElementById('langFilter').value;
            let filteredMeanings = entry.meanings || [];

            if (langFilter) {
                filteredMeanings = filteredMeanings.filter(m => m.lang === langFilter);
            }

            let meaningIndex = { ko: 0, en: 0 };

            const meanings = filteredMeanings
                .map(m => {
                    meaningIndex[m.lang]++;
                    return `
                    <div class="meaning-group">
                        <span class="meaning-number">${meaningIndex[m.lang]}</span>
                        <span class="meaning-lang">[${m.lang.toUpperCase()}]</span>
                        <span class="meaning-text">${formatMeaning(highlightText(m.text, searchTerm))}</span>
                    </div>
                `;
                })
                .join('');

            const examples = (entry.examples && entry.examples.length > 0) ? `
                <div class="examples">
                    <div class="examples-title">ì˜ˆë¬¸:</div>
                    ${entry.examples.map(ex => {
                const manchuText = ex && ex.manchu ? ex.manchu.toLowerCase() : '';
                const translationText = ex && ex.translation_ko ? ex.translation_ko : '';
                const convertedManchu = manchuText ? convertLatinToManchu(manchuText) : '';

                return `
                        <div class="example">
                            ${convertedManchu ? `<div class="example-manchu-wrapper"><div class="example-manchu">${highlightText(convertedManchu, searchTerm)}</div></div>` : ''}
                            <div class="example-content">
                                ${manchuText ? `<div class="example-latin">${highlightText(manchuText, searchTerm)}</div>` : ''}
                                ${translationText ? `<div class="example-translation">â†’ ${highlightText(translationText, searchTerm)}</div>` : ''}
                            </div>
                        </div>
                    `;
            }).join('')}
                </div>
            ` : '';

            const tags = (entry.tags && entry.tags.length > 0) ? `
                <div class="tags">
                    ${entry.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
            ` : '';

            const manchuHeadword = entry.headword ? convertLatinToManchu(entry.headword) : '';

            return `
                <div class="entry-card">
                    <div class="headword-section">
                        ${manchuHeadword ? `<div class="headword-manchu">${highlightText(manchuHeadword, searchTerm)}</div>` : ''}
                    </div>
                    <div class="entry-content">
                        <div class="romanization">${entry.romanization || ''}</div>
                        <div class="meanings">${meanings}</div>
                        ${examples}
                        ${tags}
                    </div>
                </div>
            `;
        }

        function highlightText(text, searchTerm) {
            if (!text || !searchTerm) return text;

            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function formatMeaning(text) {
            return text.replace(/`([^`]+)`/g, '<em>$1</em>');
        }

        function displayAllEntries() {
            displayResults(dictionaryData);
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            stats.textContent = `ğŸ“š ì´ ${dictionaryData.length}ê°œì˜ í•­ëª©`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDictionary();

            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    search();
                }
            });
        });
    </script>
</body>

</html>